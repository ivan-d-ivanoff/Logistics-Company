{% extends "base_app.html" %}

{% block title %}Parcels{% endblock %}
{% block page %}parcels{% endblock %}

{% block content %}
<div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center mb-4 gap-3">
  <div>
    <h1 class="h3 mb-1">Parcels</h1>
    <p class="text-muted mb-0">Manage all shipments and deliveries</p>
  </div>
</div>

<div class="card border-0 shadow-sm">
  <div class="card-header bg-white py-3">
    <div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center gap-3">
      <div>
        <h5 class="card-title mb-0">All Parcels</h5>
        <small class="text-muted">View and manage all registered parcels</small>
      </div>
      <div class="d-flex flex-column flex-sm-row gap-2 w-100 w-md-auto">
        <input id="parcelsSearch" class="form-control" placeholder="Search by tracking, sender, recipient..." style="min-width: 250px;">
        {% if can_register_parcel %}
        <button class="btn btn-primary" id="addParcelBtn">
          <i class="bi bi-plus-lg me-1"></i>Register Parcel
        </button>
        {% endif %}
      </div>
    </div>
  </div>
  <div class="card-body p-0">
    <div class="table-responsive">
      <table class="table table-hover mb-0" id="parcelsTable">
        <thead class="table-light">
          <tr>
            <th>Tracking #</th>
            <th>Sender</th>
            <th>Recipient</th>
            <th>Route</th>
            <th>Weight</th>
            <th>Price</th>
            <th>Status</th>
            <th>Created</th>
            {% if can_register_parcel %}<th>Actions</th>{% endif %}
          </tr>
        </thead>
        <tbody id="parcelsTableBody">
          <tr id="loadingRow">
            <td colspan="{% if can_register_parcel %}9{% else %}8{% endif %}" class="text-center text-muted py-4">
              <div class="spinner-border spinner-border-sm me-2"></div>Loading parcels...
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
  <div class="card-footer bg-white">
    <small id="parcelsCountInfo" class="text-muted">Loading...</small>
  </div>
</div>

{% if can_register_parcel %}
<!-- Create/Edit Parcel Modal -->
<div class="modal fade" id="parcelModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <div>
          <h5 class="modal-title" id="parcelModalTitle">Register New Parcel</h5>
          <small class="text-muted" id="parcelModalSubtitle">Enter parcel details</small>
        </div>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <form id="parcelForm">
        <div class="modal-body">
          <input type="hidden" id="parcelId">
          <div class="row g-3">
            <div class="col-md-6">
              <label class="form-label">Sender <span class="text-danger">*</span></label>
              <select id="parcelSender" class="form-select" required>
                <option value="">Select sender...</option>
              </select>
            </div>
            <div class="col-md-6">
              <label class="form-label">Receiver <span class="text-danger">*</span></label>
              <select id="parcelReceiver" class="form-select" required>
                <option value="">Select receiver...</option>
              </select>
            </div>
            <div class="col-md-6">
              <label class="form-label">Sender Office</label>
              <select id="parcelSenderOffice" class="form-select">
                <option value="">Use sender's address</option>
              </select>
              <small class="text-muted">Leave empty to use sender's default address</small>
            </div>
            <div class="col-md-6">
              <label class="form-label">Receiver Office</label>
              <select id="parcelReceiverOffice" class="form-select">
                <option value="">Use receiver's address</option>
              </select>
              <small class="text-muted">Leave empty to use receiver's default address</small>
            </div>
            <div class="col-md-6">
              <label class="form-label">Weight (kg) <span class="text-danger">*</span></label>
              <input type="number" id="parcelWeight" class="form-control" step="0.001" min="0.001" placeholder="e.g. 1.500" required>
            </div>
            <div class="col-md-6">
              <label class="form-label">Delivery Type <span class="text-danger">*</span></label>
              <select id="parcelDeliveryType" class="form-select" required>
                <option value="">Select type...</option>
              </select>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary" id="parcelSaveBtn">
            <i class="bi bi-check-lg me-1"></i>Save Parcel
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Update Status Modal -->
<div class="modal fade" id="statusModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <div>
          <h5 class="modal-title">Update Status</h5>
          <small class="text-muted" id="statusModalTracking">-</small>
        </div>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <form id="statusForm">
        <div class="modal-body">
          <input type="hidden" id="statusParcelId">
          <div class="mb-3">
            <label class="form-label">Current Status</label>
            <input type="text" id="statusCurrent" class="form-control" disabled>
          </div>
          <div class="mb-3">
            <label class="form-label">New Status <span class="text-danger">*</span></label>
            <select id="statusNew" class="form-select" required>
              <option value="">Select new status...</option>
            </select>
          </div>
          <div class="mb-3">
            <label class="form-label">Note (optional)</label>
            <textarea id="statusNote" class="form-control" rows="2" placeholder="Add a note..."></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary" id="statusSaveBtn">
            <i class="bi bi-check-lg me-1"></i>Update Status
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1">
  <div class="modal-dialog modal-sm">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Delete Parcel</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <p>Are you sure you want to delete parcel <strong id="deleteTracking"></strong>?</p>
        <p class="text-muted small mb-0">This action cannot be undone.</p>
      </div>
      <div class="modal-footer">
        <input type="hidden" id="deleteParcelId">
        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-danger" id="deleteConfirmBtn">
          <i class="bi bi-trash me-1"></i>Delete
        </button>
      </div>
    </div>
  </div>
</div>
{% endif %}
{% endblock %}

{% block js %}
<script>
// CSRF token setup for AJAX
var csrftoken = '{{ csrf_token }}';
$.ajaxSetup({
    beforeSend: function(xhr, settings) {
        if (!/^(GET|HEAD|OPTIONS|TRACE)$/i.test(settings.type) && !this.crossDomain) {
            xhr.setRequestHeader("X-CSRFToken", csrftoken);
        }
    }
});

$(document).ready(function() {
    var isEmployee = {{ can_register_parcel|yesno:"true,false" }};
    var parcelsData = [];
    var metadata = {};

    // Modals
    var parcelModal = isEmployee ? new bootstrap.Modal(document.getElementById('parcelModal')) : null;
    var statusModal = isEmployee ? new bootstrap.Modal(document.getElementById('statusModal')) : null;
    var deleteModal = isEmployee ? new bootstrap.Modal(document.getElementById('deleteModal')) : null;

    // Status badge colors
    function getStatusBadge(code, name) {
        var colors = {
            'CREATED': 'secondary',
            'IN_TRANSIT': 'info',
            'OUT_FOR_DELIVERY': 'warning',
            'DELIVERED': 'success',
            'RETURNED': 'danger',
            'CANCELLED': 'dark'
        };
        var color = colors[code] || 'secondary';
        return '<span class="badge bg-' + color + '">' + name + '</span>';
    }

    // Load parcels
    function loadParcels() {
        $.ajax({
            url: '{% url "parcels_api_list" %}',
            type: 'GET',
            success: function(response) {
                if (response.success) {
                    parcelsData = response.parcels;
                    metadata = {
                        clients: response.clients || [],
                        offices: response.offices || [],
                        statuses: response.statuses || [],
                        delivery_types: response.delivery_types || []
                    };
                    renderTable();
                    populateDropdowns();
                }
            },
            error: function() {
                $('#parcelsTableBody').html('<tr><td colspan="9" class="text-center text-danger py-4">Error loading parcels.</td></tr>');
            }
        });
    }

    // Render table
    function renderTable(filteredData) {
        var data = filteredData || parcelsData;
        var tbody = $('#parcelsTableBody');
        tbody.empty();

        if (data.length === 0) {
            tbody.html('<tr><td colspan="' + (isEmployee ? '9' : '8') + '" class="text-center text-muted py-4"><i class="bi bi-inbox fs-1 d-block mb-2"></i>No parcels found.</td></tr>');
            $('#parcelsCountInfo').text('No parcels');
            return;
        }

        data.forEach(function(p) {
            var route = '';
            if (p.sender_office_name) route += p.sender_office_name;
            else route += 'Address';
            route += ' â†’ ';
            if (p.receiver_office_name) route += p.receiver_office_name;
            else route += 'Address';

            var actions = '';
            if (isEmployee) {
                var canEdit = !p.is_terminal;
                var canDelete = p.status_code === 'CREATED' || p.status_code === 'CANCELLED';
                var canChangeStatus = !p.is_terminal;

                actions = '<td class="text-nowrap">';
                if (canChangeStatus) {
                    actions += '<button class="btn btn-sm btn-outline-primary me-1" onclick="openStatusModal(' + p.id + ')" title="Update Status"><i class="bi bi-arrow-repeat"></i></button>';
                }
                if (canEdit) {
                    actions += '<button class="btn btn-sm btn-outline-secondary me-1" onclick="openEditModal(' + p.id + ')" title="Edit"><i class="bi bi-pencil"></i></button>';
                }
                if (canDelete) {
                    actions += '<button class="btn btn-sm btn-outline-danger" onclick="openDeleteModal(' + p.id + ')" title="Delete"><i class="bi bi-trash"></i></button>';
                }
                actions += '</td>';
            }

            var row = '<tr data-id="' + p.id + '">' +
                '<td><code>' + p.tracking_number + '</code></td>' +
                '<td>' + p.sender_name + '</td>' +
                '<td>' + p.receiver_name + '</td>' +
                '<td><small>' + route + '</small></td>' +
                '<td>' + p.weight_kg.toFixed(3) + ' kg</td>' +
                '<td>' + p.price.toFixed(2) + ' BGN</td>' +
                '<td>' + getStatusBadge(p.status_code, p.status_name) + '</td>' +
                '<td><small>' + p.created_at + '</small></td>' +
                actions +
                '</tr>';
            tbody.append(row);
        });

        $('#parcelsCountInfo').html('Showing <strong>' + data.length + '</strong> parcel' + (data.length !== 1 ? 's' : ''));
    }

    // Populate dropdowns
    function populateDropdowns() {
        if (!isEmployee) return;

        // Clients
        var clientOptions = '<option value="">Select...</option>';
        metadata.clients.forEach(function(c) {
            clientOptions += '<option value="' + c.id + '">' + c.name + ' (' + c.email + ')</option>';
        });
        $('#parcelSender, #parcelReceiver').html(clientOptions);

        // Offices
        var officeOptions = '<option value="">Use default address</option>';
        metadata.offices.forEach(function(o) {
            officeOptions += '<option value="' + o.id + '">' + o.name + ' (' + o.code + ')</option>';
        });
        $('#parcelSenderOffice, #parcelReceiverOffice').html(officeOptions);

        // Delivery types
        var typeOptions = '<option value="">Select type...</option>';
        metadata.delivery_types.forEach(function(t) {
            typeOptions += '<option value="' + t.value + '">' + t.label + '</option>';
        });
        $('#parcelDeliveryType').html(typeOptions);

        // Statuses (for status modal)
        var statusOptions = '<option value="">Select status...</option>';
        metadata.statuses.forEach(function(s) {
            statusOptions += '<option value="' + s.code + '">' + s.name + '</option>';
        });
        $('#statusNew').html(statusOptions);
    }

    // Search
    $('#parcelsSearch').on('keyup', function() {
        var q = $(this).val().toLowerCase();
        if (!q) {
            renderTable();
            return;
        }
        var filtered = parcelsData.filter(function(p) {
            return p.tracking_number.toLowerCase().includes(q) ||
                   p.sender_name.toLowerCase().includes(q) ||
                   p.receiver_name.toLowerCase().includes(q) ||
                   p.status_name.toLowerCase().includes(q);
        });
        renderTable(filtered);
    });

    // Add Parcel
    if (isEmployee) {
        $('#addParcelBtn').on('click', function() {
            $('#parcelId').val('');
            $('#parcelForm')[0].reset();
            $('#parcelModalTitle').text('Register New Parcel');
            $('#parcelModalSubtitle').text('Enter parcel details');
            parcelModal.show();
        });

        // Save Parcel
        $('#parcelForm').on('submit', function(e) {
            e.preventDefault();
            var id = $('#parcelId').val();
            var data = {
                sender_id: $('#parcelSender').val(),
                receiver_id: $('#parcelReceiver').val(),
                sender_office_id: $('#parcelSenderOffice').val() || null,
                receiver_office_id: $('#parcelReceiverOffice').val() || null,
                weight_kg: $('#parcelWeight').val(),
                delivery_type: $('#parcelDeliveryType').val()
            };

            var url = id ? '/parcels/api/' + id + '/update/' : '{% url "parcels_api_create" %}';
            var method = id ? 'PUT' : 'POST';

            $('#parcelSaveBtn').prop('disabled', true).html('<span class="spinner-border spinner-border-sm me-1"></span>Saving...');

            $.ajax({
                url: url,
                type: method,
                contentType: 'application/json',
                data: JSON.stringify(data),
                success: function(response) {
                    if (response.success) {
                        parcelModal.hide();
                        loadParcels();
                        if (!id) {
                            alert('Parcel created! Tracking: ' + response.parcel.tracking_number);
                        }
                    } else {
                        alert('Error: ' + response.error);
                    }
                },
                error: function(xhr) {
                    var msg = 'An error occurred.';
                    if (xhr.responseJSON && xhr.responseJSON.error) {
                        msg = xhr.responseJSON.error;
                    }
                    alert('Error: ' + msg);
                },
                complete: function() {
                    $('#parcelSaveBtn').prop('disabled', false).html('<i class="bi bi-check-lg me-1"></i>Save Parcel');
                }
            });
        });

        // Status Form
        $('#statusForm').on('submit', function(e) {
            e.preventDefault();
            var parcelId = $('#statusParcelId').val();
            var data = {
                status_code: $('#statusNew').val(),
                note: $('#statusNote').val()
            };

            $('#statusSaveBtn').prop('disabled', true).html('<span class="spinner-border spinner-border-sm me-1"></span>Updating...');

            $.ajax({
                url: '/parcels/api/' + parcelId + '/status/',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(data),
                success: function(response) {
                    if (response.success) {
                        statusModal.hide();
                        loadParcels();
                    } else {
                        alert('Error: ' + response.error);
                    }
                },
                error: function(xhr) {
                    var msg = 'An error occurred.';
                    if (xhr.responseJSON && xhr.responseJSON.error) {
                        msg = xhr.responseJSON.error;
                    }
                    alert('Error: ' + msg);
                },
                complete: function() {
                    $('#statusSaveBtn').prop('disabled', false).html('<i class="bi bi-check-lg me-1"></i>Update Status');
                }
            });
        });

        // Delete Confirm
        $('#deleteConfirmBtn').on('click', function() {
            var parcelId = $('#deleteParcelId').val();

            $(this).prop('disabled', true).html('<span class="spinner-border spinner-border-sm me-1"></span>Deleting...');

            $.ajax({
                url: '/parcels/api/' + parcelId + '/delete/',
                type: 'DELETE',
                success: function(response) {
                    if (response.success) {
                        deleteModal.hide();
                        loadParcels();
                    } else {
                        alert('Error: ' + response.error);
                    }
                },
                error: function(xhr) {
                    var msg = 'An error occurred.';
                    if (xhr.responseJSON && xhr.responseJSON.error) {
                        msg = xhr.responseJSON.error;
                    }
                    alert('Error: ' + msg);
                },
                complete: function() {
                    $('#deleteConfirmBtn').prop('disabled', false).html('<i class="bi bi-trash me-1"></i>Delete');
                }
            });
        });
    }

    // Global functions for action buttons
    window.openEditModal = function(id) {
        var parcel = parcelsData.find(function(p) { return p.id === id; });
        if (!parcel) return;

        $('#parcelId').val(parcel.id);
        $('#parcelSender').val(parcel.sender_id);
        $('#parcelReceiver').val(parcel.receiver_id);
        $('#parcelSenderOffice').val(parcel.sender_office_id || '');
        $('#parcelReceiverOffice').val(parcel.receiver_office_id || '');
        $('#parcelWeight').val(parcel.weight_kg);
        $('#parcelDeliveryType').val(parcel.delivery_type);
        $('#parcelModalTitle').text('Edit Parcel');
        $('#parcelModalSubtitle').text(parcel.tracking_number);
        parcelModal.show();
    };

    window.openStatusModal = function(id) {
        var parcel = parcelsData.find(function(p) { return p.id === id; });
        if (!parcel) return;

        $('#statusParcelId').val(parcel.id);
        $('#statusModalTracking').text(parcel.tracking_number);
        $('#statusCurrent').val(parcel.status_name);
        $('#statusNew').val('');
        $('#statusNote').val('');
        statusModal.show();
    };

    window.openDeleteModal = function(id) {
        var parcel = parcelsData.find(function(p) { return p.id === id; });
        if (!parcel) return;

        $('#deleteParcelId').val(parcel.id);
        $('#deleteTracking').text(parcel.tracking_number);
        deleteModal.show();
    };

    // Initial load
    loadParcels();
});
</script>
{% endblock %}
