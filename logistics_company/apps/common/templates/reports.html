{% extends "base_app.html" %}

{% block title %}Reports{% endblock %}
{% block page %}reports{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
  <div>
    <h1 class="h3 mb-1">Reports</h1>
    <p class="text-muted mb-0">Generate and download various reports</p>
  </div>
</div>

<!-- Filters Card -->
<div class="card border-0 shadow-sm mb-4">
  <div class="card-header bg-white py-3">
    <h5 class="card-title mb-0"><i class="bi bi-funnel me-2"></i>Report Filters</h5>
  </div>
  <div class="card-body">
    <div class="row g-3">
      <div class="col-sm-6 col-lg-3">
        <label class="form-label small">Date From</label>
        <input id="filterDateFrom" type="date" class="form-control">
      </div>
      <div class="col-sm-6 col-lg-3">
        <label class="form-label small">Date To</label>
        <input id="filterDateTo" type="date" class="form-control">
      </div>
      <div class="col-sm-6 col-lg-3">
        <label class="form-label small">Employee</label>
        <select id="filterEmployee" class="form-select">
          <option value="">-- Select Employee --</option>
          {% for emp in employees %}
            <option value="{{ emp.pk }}">{{ emp.user.first_name }} {{ emp.user.last_name }} ({{ emp.employee_code }})</option>
          {% endfor %}
        </select>
      </div>
      <div class="col-sm-6 col-lg-3">
        <label class="form-label small">Client</label>
        <select id="filterClient" class="form-select">
          <option value="">-- Select Client --</option>
          {% for client in clients %}
            <option value="{{ client.id }}">{{ client.first_name }} {{ client.last_name }} ({{ client.email }})</option>
          {% endfor %}
        </select>
      </div>
    </div>
  </div>
</div>

<!-- Report Cards Grid -->
<div class="row g-4 mb-4">
  <div class="col-sm-6 col-lg-4 col-xl-3">
    <div class="card border-0 shadow-sm h-100">
      <div class="card-body">
        <h6 class="card-title"><i class="bi bi-people text-primary me-2"></i>All Employees Report</h6>
        <p class="card-text small text-muted">Complete list of all company employees with their details.</p>
        <button class="btn btn-primary btn-sm" id="btn-employees-all">Generate Report</button>
      </div>
    </div>
  </div>

  <div class="col-sm-6 col-lg-4 col-xl-3">
    <div class="card border-0 shadow-sm h-100">
      <div class="card-body">
        <h6 class="card-title"><i class="bi bi-person-lines-fill text-primary me-2"></i>All Clients Report</h6>
        <p class="card-text small text-muted">Complete list of all registered clients.</p>
        <button class="btn btn-primary btn-sm" id="btn-clients-all">Generate Report</button>
      </div>
    </div>
  </div>

  <div class="col-sm-6 col-lg-4 col-xl-3">
    <div class="card border-0 shadow-sm h-100">
      <div class="card-body">
        <h6 class="card-title"><i class="bi bi-box-seam text-primary me-2"></i>All Parcels Report</h6>
        <p class="card-text small text-muted">All parcels registered in the system.</p>
        <button class="btn btn-primary btn-sm" id="btn-parcels-all">Generate Report</button>
      </div>
    </div>
  </div>

  <div class="col-sm-6 col-lg-4 col-xl-3">
    <div class="card border-0 shadow-sm h-100">
      <div class="card-body">
        <h6 class="card-title"><i class="bi bi-person-badge text-primary me-2"></i>Parcels by Employee</h6>
        <p class="card-text small text-muted">All parcels registered by a specific employee.</p>
        <button class="btn btn-secondary btn-sm btn-requires-employee" id="btn-parcels-by-employee" disabled>Select Employee First</button>
      </div>
    </div>
  </div>

  <div class="col-sm-6 col-lg-4 col-xl-3">
    <div class="card border-0 shadow-sm h-100">
      <div class="card-body">
        <h6 class="card-title"><i class="bi bi-clock-history text-warning me-2"></i>Pending Deliveries</h6>
        <p class="card-text small text-muted">Parcels that have been sent but not yet received.</p>
        <button class="btn btn-primary btn-sm" id="btn-pending-deliveries">Generate Report</button>
      </div>
    </div>
  </div>

  <div class="col-sm-6 col-lg-4 col-xl-3">
    <div class="card border-0 shadow-sm h-100">
      <div class="card-body">
        <h6 class="card-title"><i class="bi bi-send text-success me-2"></i>Client Sent Parcels</h6>
        <p class="card-text small text-muted">All parcels sent by a specific client.</p>
        <button class="btn btn-secondary btn-sm btn-requires-client" id="btn-client-sent" disabled>Select Client First</button>
      </div>
    </div>
  </div>

  <div class="col-sm-6 col-lg-4 col-xl-3">
    <div class="card border-0 shadow-sm h-100">
      <div class="card-body">
        <h6 class="card-title"><i class="bi bi-inbox text-info me-2"></i>Client Received Parcels</h6>
        <p class="card-text small text-muted">All parcels received by a specific client.</p>
        <button class="btn btn-secondary btn-sm btn-requires-client" id="btn-client-received" disabled>Select Client First</button>
      </div>
    </div>
  </div>

  <div class="col-sm-6 col-lg-4 col-xl-3">
    <div class="card border-0 shadow-sm h-100">
      <div class="card-body">
        <h6 class="card-title"><i class="bi bi-currency-dollar text-success me-2"></i>Income Report</h6>
        <p class="card-text small text-muted">Company income for a specified period.</p>
        <button class="btn btn-primary btn-sm" id="btn-income-report">Generate Report</button>
      </div>
    </div>
  </div>
</div>

<!-- Report Output Card -->
<div class="card border-0 shadow-sm">
  <div class="card-header bg-white py-3">
    <h5 class="card-title mb-0" id="reportTitle"><i class="bi bi-table me-2"></i>Report Output</h5>
    <small class="text-muted" id="reportSubtitle">Select a report to generate.</small>
  </div>
  <div class="card-body">
    <div id="reportSummary" class="alert alert-info d-none"></div>
    <div class="table-responsive" id="reportTableWrapper" style="display:none;">
      <table class="table table-striped table-hover" id="reportTable">
        <thead class="table-dark" id="reportThead"></thead>
        <tbody id="reportTbody"></tbody>
      </table>
    </div>
    <div id="exportButtonWrapper" class="mt-3" style="display:none;">
      <button class="btn btn-success" id="exportExcelBtn">
        <i class="bi bi-file-earmark-excel me-2"></i>Export to Excel
      </button>
    </div>
  </div>
</div>
{% endblock %}

{% block js %}
<script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
<script>
$(document).ready(function() {
    // Store current report data for export
    var currentReportData = null;
    var currentReportHeaders = null;
    var currentReportTitle = "";

    // Enable/disable buttons based on dropdown selection
    $("#filterClient").on("change", function() {
        var hasValue = $(this).val() !== "";
        $(".btn-requires-client").prop("disabled", !hasValue);
        if (hasValue) {
            $(".btn-requires-client").removeClass("btn-secondary").addClass("btn-primary").text("Generate Report");
        } else {
            $(".btn-requires-client").removeClass("btn-primary").addClass("btn-secondary").text("Select Client First");
        }
    });

    $("#filterEmployee").on("change", function() {
        var hasValue = $(this).val() !== "";
        $(".btn-requires-employee").prop("disabled", !hasValue);
        if (hasValue) {
            $(".btn-requires-employee").removeClass("btn-secondary").addClass("btn-primary").text("Generate Report");
        } else {
            $(".btn-requires-employee").removeClass("btn-primary").addClass("btn-secondary").text("Select Employee First");
        }
    });

    // Helper function to render table
    function renderTable(headers, rows, title, summary) {
        currentReportHeaders = headers;
        currentReportData = rows;
        currentReportTitle = title;

        $("#reportTitle").html('<i class="bi bi-table me-2"></i>' + title);
        $("#reportSubtitle").text("");
        $("#reportSummary").html(summary).removeClass("d-none");

        var thead = "<tr>";
        headers.forEach(function(h) {
            thead += "<th>" + h.label + "</th>";
        });
        thead += "</tr>";
        $("#reportThead").html(thead);

        var tbody = "";
        if (rows.length === 0) {
            tbody = '<tr><td colspan="' + headers.length + '" class="text-center text-muted py-4">No data found</td></tr>';
        } else {
            rows.forEach(function(row) {
                tbody += "<tr>";
                headers.forEach(function(h) {
                    var val = row[h.key] !== undefined && row[h.key] !== null ? row[h.key] : "-";
                    tbody += "<td>" + val + "</td>";
                });
                tbody += "</tr>";
            });
        }
        $("#reportTbody").html(tbody);

        $("#reportTableWrapper").show();
        if (rows.length > 0) {
            $("#exportButtonWrapper").show();
        } else {
            $("#exportButtonWrapper").hide();
        }
    }

    // Helper function to show error
    function showError(message) {
        $("#reportTitle").html('<i class="bi bi-exclamation-triangle me-2"></i>Error');
        $("#reportSubtitle").text(message);
        $("#reportSummary").html("").addClass("d-none");
        $("#reportTableWrapper").hide();
        $("#exportButtonWrapper").hide();
    }

    // Helper function to show loading
    function showLoading(title) {
        $("#reportTitle").html('<i class="bi bi-hourglass-split me-2"></i>' + title);
        $("#reportSubtitle").text("Loading...");
        $("#reportSummary").html("").addClass("d-none");
        $("#reportTableWrapper").hide();
        $("#exportButtonWrapper").hide();
    }

    // Export to Excel functionality
    $("#exportExcelBtn").on("click", function() {
        if (!currentReportData || !currentReportHeaders) {
            alert("No data to export");
            return;
        }

        // Build data array for SheetJS
        var wsData = [];

        // Add header row
        var headerRow = currentReportHeaders.map(function(h) {
            return h.label;
        });
        wsData.push(headerRow);

        // Add data rows
        currentReportData.forEach(function(row) {
            var rowData = currentReportHeaders.map(function(h) {
                var val = row[h.key] !== undefined && row[h.key] !== null ? row[h.key] : "";
                return val;
            });
            wsData.push(rowData);
        });

        // Create worksheet
        var ws = XLSX.utils.aoa_to_sheet(wsData);

        // Calculate column widths based on content
        var colWidths = currentReportHeaders.map(function(h, colIndex) {
            var maxLen = h.label.length;
            currentReportData.forEach(function(row) {
                var val = row[h.key] !== undefined && row[h.key] !== null ? String(row[h.key]) : "";
                if (val.length > maxLen) {
                    maxLen = val.length;
                }
            });
            return { wch: Math.min(maxLen + 2, 50) };
        });
        ws['!cols'] = colWidths;

        // Create workbook and add worksheet
        var wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Report");

        // Generate filename and download
        var filename = currentReportTitle.replace(/\s+/g, "_") + "_" + new Date().toISOString().slice(0,10) + ".xlsx";
        XLSX.writeFile(wb, filename);
    });

    // All Employees Report
    $("#btn-employees-all").on("click", function() {
        showLoading("All Employees Report");
        $.ajax({
            url: "{% url 'reports_employees' %}",
            type: "GET",
            success: function(response) {
                var headers = [
                    { key: "employee_code", label: "Code" },
                    { key: "first_name", label: "First Name" },
                    { key: "last_name", label: "Last Name" },
                    { key: "email", label: "Email" },
                    { key: "phone", label: "Phone" },
                    { key: "employee_type", label: "Type" },
                    { key: "office", label: "Office" },
                    { key: "hire_date", label: "Hire Date" },
                    { key: "salary", label: "Salary" }
                ];
                var summary = "<strong>Total Employees:</strong> " + response.employees_count;
                renderTable(headers, response.employees, "All Employees Report", summary);
            },
            error: function(xhr) {
                showError("Error loading employees report.");
            }
        });
    });

    // All Clients Report
    $("#btn-clients-all").on("click", function() {
        showLoading("All Clients Report");
        $.ajax({
            url: "{% url 'reports_client' %}",
            type: "GET",
            success: function(response) {
                var headers = [
                    { key: "first_name", label: "First Name" },
                    { key: "last_name", label: "Last Name" },
                    { key: "email", label: "Email" },
                    { key: "phone", label: "Phone" },
                    { key: "default_address", label: "Default Address" },
                    { key: "created_at", label: "Registered At" }
                ];
                var summary = "<strong>Total Clients:</strong> " + response.clients_count;
                renderTable(headers, response.clients, "All Clients Report", summary);
            },
            error: function(xhr) {
                showError("Error loading clients report.");
            }
        });
    });

    var parcelHeaders = [
        { key: "tracking_number", label: "Tracking #" },
        { key: "status", label: "Status" },
        { key: "delivery_type", label: "Type" },
        { key: "sender", label: "Sender" },
        { key: "receiver", label: "Receiver" },
        { key: "sender_office", label: "From Office" },
        { key: "receiver_office", label: "To Office" },
        { key: "price", label: "Price" },
        { key: "weight_kg", label: "Weight (kg)" },
        { key: "created_at", label: "Created" },
        { key: "delivered_at", label: "Delivered" }
    ];

    // All Parcels Report
    $("#btn-parcels-all").on("click", function() {
        showLoading("All Parcels Report");
        $.ajax({
            url: "{% url 'reports_client_parcels_all' role='all' %}",
            type: "GET",
            success: function(response) {
                var summary = "<strong>Total Parcels:</strong> " + response.parcels_count;
                renderTable(parcelHeaders, response.parcels, "All Parcels Report", summary);
            },
            error: function(xhr) {
                showError("Error loading parcels report.");
            }
        });
    });

    // Client Sent Parcels
    $("#btn-client-sent").on("click", function() {
        var clientId = $("#filterClient").val();
        if (!clientId) return;
        showLoading("Client Sent Parcels");
        $.ajax({
            url: "/reports/client-parcels/" + clientId + "/sent/",
            type: "GET",
            success: function(response) {
                var summary = "<strong>Client:</strong> " + response.client_name + " | <strong>Parcels Sent:</strong> " + response.parcels_count;
                renderTable(parcelHeaders, response.parcels, "Client Sent Parcels", summary);
            },
            error: function(xhr) {
                showError("Error loading client sent parcels report.");
            }
        });
    });

    // Client Received Parcels
    $("#btn-client-received").on("click", function() {
        var clientId = $("#filterClient").val();
        if (!clientId) return;
        showLoading("Client Received Parcels");
        $.ajax({
            url: "/reports/client-parcels/" + clientId + "/received/",
            type: "GET",
            success: function(response) {
                var summary = "<strong>Client:</strong> " + response.client_name + " | <strong>Parcels Received:</strong> " + response.parcels_count;
                renderTable(parcelHeaders, response.parcels, "Client Received Parcels", summary);
            },
            error: function(xhr) {
                showError("Error loading client received parcels report.");
            }
        });
    });

    // Parcels by Employee
    $("#btn-parcels-by-employee").on("click", function() {
        var employeeId = $("#filterEmployee").val();
        if (!employeeId) return;
        showLoading("Parcels by Employee");
        $.ajax({
            url: "/reports/parcels-by-employee/" + employeeId + "/",
            type: "GET",
            success: function(response) {
                var headers = [
                    { key: "tracking_number", label: "Tracking #" },
                    { key: "status", label: "Status" },
                    { key: "delivery_type", label: "Type" },
                    { key: "sender", label: "Sender" },
                    { key: "receiver", label: "Receiver" },
                    { key: "price", label: "Price" },
                    { key: "weight_kg", label: "Weight (kg)" },
                    { key: "created_at", label: "Created" },
                    { key: "delivered_at", label: "Delivered" },
                    { key: "registered_by", label: "Registered By" }
                ];
                var summary = "<strong>Employee:</strong> " + response.employee_name + " | <strong>Parcels Registered:</strong> " + response.parcels_count;
                renderTable(headers, response.parcels, "Parcels by Employee", summary);
            },
            error: function(xhr) {
                showError("Error loading parcels by employee report.");
            }
        });
    });

    // Pending Deliveries
    $("#btn-pending-deliveries").on("click", function() {
        showLoading("Pending Deliveries");
        $.ajax({
            url: "{% url 'reports_pending_deliveries' %}",
            type: "GET",
            success: function(response) {
                var headers = [
                    { key: "tracking_number", label: "Tracking #" },
                    { key: "status", label: "Status" },
                    { key: "delivery_type", label: "Type" },
                    { key: "sender", label: "Sender" },
                    { key: "receiver", label: "Receiver" },
                    { key: "sender_office", label: "From Office" },
                    { key: "receiver_office", label: "To Office" },
                    { key: "price", label: "Price" },
                    { key: "weight_kg", label: "Weight (kg)" },
                    { key: "created_at", label: "Created" }
                ];
                var summary = "<strong>Pending Deliveries:</strong> " + response.pending_count;
                renderTable(headers, response.parcels, "Pending Deliveries", summary);
            },
            error: function(xhr) {
                showError("Error loading pending deliveries report.");
            }
        });
    });

    // Income Report
    $("#btn-income-report").on("click", function() {
        showLoading("Income Report");
        var dateFrom = $("#filterDateFrom").val();
        var dateTo = $("#filterDateTo").val();
        var url = "{% url 'reports_income' %}";
        var params = [];
        if (dateFrom) params.push("date_from=" + dateFrom);
        if (dateTo) params.push("date_to=" + dateTo);
        if (params.length > 0) url += "?" + params.join("&");

        $.ajax({
            url: url,
            type: "GET",
            success: function(response) {
                var headers = [
                    { key: "tracking_number", label: "Tracking #" },
                    { key: "delivery_type", label: "Type" },
                    { key: "sender", label: "Sender" },
                    { key: "receiver", label: "Receiver" },
                    { key: "price", label: "Price" },
                    { key: "delivered_at", label: "Delivered At" }
                ];
                var summary = "<strong>Period:</strong> " + response.date_from + " to " + response.date_to +
                    " | <strong>Total Parcels:</strong> " + response.parcels_count +
                    " | <strong>Total Income:</strong> " + response.total_income.toFixed(2) + " BGN";
                renderTable(headers, response.parcels, "Income Report", summary);
            },
            error: function(xhr) {
                showError("Error loading income report.");
            }
        });
    });
});
</script>
{% endblock %}
